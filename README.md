# ccpmbuild

A powerful build tool and repository management system for [ComputerCraft Package Manager (CCPM)](https://github.com/deleranax/ccpm), written in Rust.

**ccpmbuild** processes CCPM package repositories by compressing packages, generating metadata, and creating distribution-ready package pools with automatic indexing.

## Features

- üöÄ **Fast & Efficient** - Built in Rust for maximum performance
- üóúÔ∏è **Package Compression** - Creates optimized `.ccp` package files
- üì¶ **Automatic Indexing** - Generates package indexes with metadata and checksums
- ‚ú® **Lua Minification** - Optional source code minification to reduce package size
- üîß **Repository Management** - Build and maintain CCPM repositories with ease
- üê≥ **Container Support** - Available as a Docker/OCI container image
- üîÑ **Version Control** - Optional package version history maintenance
- ‚úÖ **Validation** - Validates package manifests and SPDX license identifiers

## Installation

### Pre-built Binaries

Download the latest release for your platform from the [releases page](https://github.com/deleranax/ccpmbuild/releases):

- Linux (x86_64): `ccpmbuild-x86_64-unknown-linux-gnu`
- Linux (ARM64): `ccpmbuild-aarch64-unknown-linux-gnu`
- Windows (x86_64): `ccpmbuild-x86_64-pc-windows-msvc.exe`
- Windows (ARM64): `ccpmbuild-aarch64-pc-windows-msvc.exe`

Make the binary executable (Linux):
```bash
chmod +x ccpmbuild-*
sudo mv ccpmbuild-* /usr/local/bin/ccpmbuild
```

### Container Image

Pull the latest container image:
```bash
docker pull ghcr.io/deleranax/ccpmbuild:latest
```

Or use with Podman:
```bash
podman pull ghcr.io/deleranax/ccpmbuild:latest
```

### Build from Source

Requirements:
- Rust 2024 edition or later
- Cargo

```bash
git clone https://github.com/deleranax/ccpmbuild.git
cd ccpmbuild
cargo build --release
```

The compiled binary will be at `target/release/ccpmbuild`.

## Usage

### Basic Build

Build a CCPM repository from source:

```bash
ccpmbuild build <INPUT_DIR> <OUTPUT_DIR>
```

- `<INPUT_DIR>`: Directory containing `manifest.json` and `packages/` folder
- `<OUTPUT_DIR>`: Destination directory where the `pool/` folder will be created

### Build with Minification

Minify Lua source code to reduce package size:

```bash
ccpmbuild build --minify <INPUT_DIR> <OUTPUT_DIR>
```

### Examples

```bash
# Build without minification
ccpmbuild build . .

# Build with minification
ccpmbuild build --minify . dist

# Build from a specific directory
ccpmbuild build /path/to/source /path/to/output

# Using container
docker run --rm -v $(pwd):/workspace ghcr.io/deleranax/ccpmbuild:latest build --minify /workspace /workspace
```

## Setting Up a CCPM Repository

For detailed instructions on creating and hosting your own CCPM repository, including:
- Repository structure and manifest format
- Package manifest requirements
- CI/CD setup for various Git forges
- Manual and automated deployment options

Please refer to the **[Setting Up Your Own Repository](https://github.com/deleranax/ccpm#setting-up-your-own-repository-git-forges)** section in the CCPM documentation.

### Quick Overview

ccpmbuild expects the following structure:

```
your-repo/
‚îú‚îÄ‚îÄ manifest.json          # Repository metadata
‚îú‚îÄ‚îÄ packages/              # Package source directory
‚îÇ   ‚îî‚îÄ‚îÄ your-package/
‚îÇ       ‚îú‚îÄ‚îÄ manifest.json  # Package metadata
‚îÇ       ‚îî‚îÄ‚îÄ source/        # Package files
‚îî‚îÄ‚îÄ pool/                  # Generated by ccpmbuild
    ‚îú‚îÄ‚îÄ index.json
    ‚îú‚îÄ‚îÄ manifest.json
    ‚îî‚îÄ‚îÄ *.ccp
```

Run `ccpmbuild build` to process packages from `packages/` into the `pool/` directory.

## CI/CD Integration

### GitHub Actions

Use the [ccpmbuild-action](https://github.com/deleranax/ccpmbuild-action) for automated builds:

```yaml
name: Build CCPM Repository

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build CCPM repository
        uses: deleranax/ccpmbuild-action@v1
        with:
          minify: 'true'
          branch-name: 'dist'
```

See the [ccpmbuild-action documentation](https://github.com/deleranax/ccpmbuild-action) for more options.

### Other CI/CD Systems

You can use ccpmbuild in any CI/CD system. Example using the container image:

```bash
# Pull the container
docker pull ghcr.io/deleranax/ccpmbuild:latest

# Build packages
docker run --rm -v $(pwd):/workspace \
  ghcr.io/deleranax/ccpmbuild:latest \
  build --minify /workspace /workspace

# Commit and push to distribution branch
git checkout dist
git add pool/
git commit -m "Update packages"
git push origin dist
```

## Package Format (`.ccp`)

Packages are built as `.ccp` files containing an intermediate JSON structure that is then compressed and encoded:

**Intermediate JSON Structure:**
```json
{
  "name": "package-name",
  "version": "1.0.0",
  "description": "Package description",
  "license": "GPL-3.0-or-later",
  "authors": ["..."],
  "maintainers": ["..."],
  "dependencies": ["..."],
  "files": {
    "path/to/file.lua": {
      "content": "file-content-string",
      "digest": "sha256-hash-of-file"
    }
  }
}
```

**Package Processing Pipeline:**

1. **File Processing**: Each file in the package is read and optionally minified (Lua files only, using [darklua](https://github.com/seaofvoices/darklua))
2. **File Checksums**: A SHA256 hash (`digest`) is computed for each processed file
3. **JSON Serialization**: The entire package structure (metadata + all files with their digests) is serialized to JSON
4. **Compression**: The complete JSON is compressed using DEFLATE algorithm (libdeflate implementation)
5. **Encoding**: The compressed binary data is base64-encoded
6. **Package Checksum**: A SHA256 hash (`digest`) is computed for the final base64-encoded package

The `.ccp` file contains the base64-encoded compressed JSON. The package checksum is stored in `index.json` for integrity verification during downloads.

## Version Management

By default, ccpmbuild replaces old package versions. To keep multiple versions:

1. Don't delete the `pool/` directory between builds
2. Use the `keep` option in GitHub Actions:

```yaml
- uses: deleranax/ccpmbuild-action@v1
  with:
    keep: 'true'
```

This maintains a version history, allowing users to install specific package versions.

## Development

### Building from Source

```bash
# Debug build
cargo build

# Release build (optimized)
cargo build --release

# Run with arguments
cargo run -- build --minify . .
```

## Related Projects

- [**ccpm**](https://github.com/deleranax/ccpm) - The ComputerCraft Package Manager
- [**ccpmbuild-action**](https://github.com/deleranax/ccpmbuild-action) - GitHub Action for automated builds

## License

This project is licensed under the **GNU General Public License v3.0 or later**. See the [LICENSE](LICENSE) file for details.

As per the GPL-3.0, you are free to use, modify, and distribute this software, but you must:
- Provide the source code for any modifications
- State the changes you have made
- Include a copy of the GPL-3.0 license
- Credit the original author: Alexandre Leconte <aleconte@dwightstudio.fr>

## Author

**Alexandre Leconte** <aleconte@dwightstudio.fr>

## Support

For questions, issues, or support:
- Open an issue on [GitHub](https://github.com/deleranax/ccpmbuild/issues)
- See the [CCPM documentation](https://github.com/deleranax/ccpm)